import React, { useEffect, useMemo, useRef, useState } from 'react'

import CollageGrid from './components/CollageGrid'
import SpeedControl from './components/SpeedControl'
import WritingSystemCard from './components/WritingSystemCard'
import { writingSystems } from './alphabets'
import {
	buildCharacterPool,
	GRID_CELL_COUNT,
	DEFAULT_MAX_SHIFT_PX,
	DEFAULT_MIN_DURATION,
	DEFAULT_MAX_DURATION,
	CharacterCell
} from './utils/collageData'
import './styles/AlphabetsCollage.css'

const SPEED_MIN = 0.4
const SPEED_MAX = 2.5
const SPEED_STEP = 0.05
const RANDOM_SEED = 0xdecafc0
const STORAGE_KEY = 'alphabets-active-characters'

type ActiveCharactersMap = Record<string, string[]>

declare global {
	interface Window {
		alphabetsActiveCharacters?: Record<string, string[]>
	}
}

const cloneActiveCharacters = (
	source: ActiveCharactersMap
): ActiveCharactersMap =>
	Object.fromEntries(
		Object.entries(source).map(([id, chars]) => [id, [...chars]])
	)

const buildDefaultActiveCharacters = (): ActiveCharactersMap => {
	const initial = {
		latin: [
			'A',
			'B',
			'C',
			'D',
			'E',
			'F',
			'G',
			'H',
			'I',
			'J',
			'K',
			'L',
			'M',
			'N',
			'O',
			'P',
			'Q',
			'R',
			'S',
			'T',
			'U',
			'V',
			'W',
			'X',
			'Y',
			'Z',
			'a',
			'b',
			'c',
			'd',
			'e',
			'f',
			'g',
			'h',
			'i',
			'j',
			'k',
			'l',
			'm',
			'n',
			'o',
			'p',
			'q',
			'r',
			's',
			't',
			'u',
			'v',
			'w',
			'x',
			'y',
			'z',
			'√Ü',
			'√ò',
			'≈í',
			'√ü'
		],
		cyrillic: [
			'–ê',
			'–ë',
			'–í',
			'–ì',
			'–î',
			'–ï',
			'–Å',
			'–ñ',
			'–ó',
			'–ò',
			'–ô',
			'–ö',
			'–õ',
			'–ú',
			'–ù',
			'–û',
			'–ü',
			'–†',
			'–°',
			'–¢',
			'–£',
			'–§',
			'–•',
			'–¶',
			'–ß',
			'–®',
			'–©',
			'–™',
			'–´',
			'–¨',
			'–≠',
			'–Æ',
			'–Ø',
			'–Ñ',
			'–â',
			'–ä',
			'–ã',
			'–è',
			'“∫',
			'”ò',
			'”®'
		],
		greek: [
			'Œë',
			'Œí',
			'Œì',
			'Œî',
			'Œï',
			'Œñ',
			'Œó',
			'Œò',
			'Œô',
			'Œö',
			'Œõ',
			'Œú',
			'Œù',
			'Œû',
			'Œü',
			'Œ†',
			'Œ°',
			'Œ£',
			'Œ§',
			'Œ•',
			'Œ¶',
			'Œß',
			'Œ®',
			'Œ©',
			'Œ±',
			'Œ≤',
			'Œ≥',
			'Œ¥',
			'Œµ',
			'Œ∂',
			'Œ∑',
			'Œ∏',
			'Œπ',
			'Œ∫',
			'Œª',
			'Œº',
			'ŒΩ',
			'Œæ',
			'Œø',
			'œÄ',
			'œÅ',
			'œÉ',
			'œÇ',
			'œÑ',
			'œÖ',
			'œÜ',
			'œá',
			'œà',
			'œâ'
		],
		arabic: [
			'ÿ®',
			'ÿ™',
			'ÿ´',
			'ÿ¨',
			'ÿ≠',
			'ÿÆ',
			'ÿØ',
			'ÿ∞',
			'ÿ±',
			'ÿ≤',
			'ÿ≥',
			'ÿ¥',
			'ÿµ',
			'ÿ∂',
			'ÿ∑',
			'ÿ∏',
			'ÿπ',
			'ÿ∫',
			'ŸÅ',
			'ŸÇ',
			'ŸÉ',
			'ŸÑ',
			'ŸÖ',
			'ŸÜ',
			'Ÿá',
			'Ÿà',
			'Ÿä',
			'ÿ°',
			'ÿ¢',
			'ÿ©'
		],
		hebrew: [
			'◊ê',
			'◊ë',
			'◊í',
			'◊ì',
			'◊î',
			'◊ñ',
			'◊ó',
			'◊ò',
			'◊õ',
			'◊ö',
			'◊ú',
			'◊û',
			'◊ù',
			'◊†',
			'◊¢',
			'◊§',
			'◊£',
			'◊¶',
			'◊•',
			'◊ß',
			'◊®',
			'◊©',
			'◊™'
		],
		devanagari: [
			'‡§Ö',
			'‡§Ü',
			'‡§á',
			'‡§à',
			'‡§â',
			'‡§ä',
			'‡§ã',
			'‡•†',
			'‡§å',
			'‡•°',
			'‡§è',
			'‡§ê',
			'‡§ì',
			'‡§î',
			'‡§Ö‡§Ç',
			'‡§Ö‡§É',
			'‡§ï',
			'‡§ñ',
			'‡§ó',
			'‡§ò',
			'‡§ô',
			'‡§ö',
			'‡§õ',
			'‡§ú',
			'‡§ù',
			'‡§û',
			'‡§ü',
			'‡§†',
			'‡§°',
			'‡§¢',
			'‡§£',
			'‡§§',
			'‡§•',
			'‡§¶',
			'‡§ß',
			'‡§®',
			'‡§™',
			'‡§´',
			'‡§¨',
			'‡§≠',
			'‡§Æ',
			'‡§Ø',
			'‡§∞',
			'‡§≤',
			'‡§µ',
			'‡§∂',
			'‡§∑',
			'‡§∏',
			'‡§π',
			'‡§≥',
			'‡§ï‡•ç‡§∑',
			'‡§ú‡•ç‡§û'
		],
		bengali: [
			'‡¶Ö',
			'‡¶Ü',
			'‡¶á',
			'‡¶à',
			'‡¶â',
			'‡¶ä',
			'‡¶ã',
			'‡¶è',
			'‡¶ê',
			'‡¶ì',
			'‡¶î',
			'‡¶ï',
			'‡¶ñ',
			'‡¶ó',
			'‡¶ò',
			'‡¶ô',
			'‡¶ö',
			'‡¶õ',
			'‡¶ú',
			'‡¶ù',
			'‡¶û',
			'‡¶ü',
			'‡¶†',
			'‡¶°',
			'‡¶¢',
			'‡¶£',
			'‡¶§',
			'‡¶•',
			'‡¶¶',
			'‡¶ß',
			'‡¶®',
			'‡¶™',
			'‡¶´',
			'‡¶¨',
			'‡¶≠',
			'‡¶Æ',
			'‡¶Ø',
			'‡¶∞',
			'‡¶≤',
			'‡¶∂',
			'‡¶∑',
			'‡¶∏',
			'‡¶π',
			'‡¶°‡¶º',
			'‡¶¢‡¶º',
			'‡¶Ø‡¶º',
			'‡ßé'
		],
		gurmukhi: [
			'‡®Ö',
			'‡®Ü',
			'‡®á',
			'‡®à',
			'‡®â',
			'‡®ä',
			'‡®è',
			'‡®ê',
			'‡®ì',
			'‡®î',
			'‡®ï',
			'‡®ñ',
			'‡®ó',
			'‡®ò',
			'‡®ô',
			'‡®ö',
			'‡®õ',
			'‡®ú',
			'‡®ù',
			'‡®û',
			'‡®ü',
			'‡®†',
			'‡®°',
			'‡®¢',
			'‡®£',
			'‡®§',
			'‡®•',
			'‡®¶',
			'‡®ß',
			'‡®®',
			'‡®™',
			'‡®´',
			'‡®¨',
			'‡®≠',
			'‡®Æ',
			'‡®Ø',
			'‡®∞',
			'‡®≤',
			'‡®µ',
			'‡®∂',
			'‡®∏',
			'‡®π',
			'‡©ú',
			'‡©ô',
			'‡©ö',
			'‡©õ',
			'‡©û',
			'‡®≥'
		],
		gujarati: [
			'‡™Ö',
			'‡™Ü',
			'‡™á',
			'‡™à',
			'‡™â',
			'‡™ä',
			'‡™ã',
			'‡´†',
			'‡™å',
			'‡´°',
			'‡™è',
			'‡™ê',
			'‡™ì',
			'‡™î',
			'‡™ï',
			'‡™ñ',
			'‡™ó',
			'‡™ò',
			'‡™ô',
			'‡™ö',
			'‡™õ',
			'‡™ú',
			'‡™ù',
			'‡™û',
			'‡™ü',
			'‡™†',
			'‡™°',
			'‡™¢',
			'‡™£',
			'‡™§',
			'‡™•',
			'‡™¶',
			'‡™ß',
			'‡™®',
			'‡™™',
			'‡™´',
			'‡™¨',
			'‡™≠',
			'‡™Æ',
			'‡™Ø',
			'‡™∞',
			'‡™≤',
			'‡™≥',
			'‡™µ',
			'‡™∂',
			'‡™∑',
			'‡™∏',
			'‡™π',
			'‡™Ω',
			'‡´ê'
		],
		tamil: [
			'‡ÆÖ',
			'‡ÆÜ',
			'‡Æá',
			'‡Æà',
			'‡Æâ',
			'‡Æé',
			'‡Æè',
			'‡Æê',
			'‡Æí',
			'‡Æì',
			'‡ÆÉ',
			'‡Æï',
			'‡Æô',
			'‡Æö',
			'‡Æû',
			'‡Æü',
			'‡Æ§',
			'‡Æ®',
			'‡Æ™',
			'‡ÆÆ',
			'‡ÆØ',
			'‡Æ∞',
			'‡Æ≤',
			'‡Æµ',
			'‡Æ¥',
			'‡Æ≥',
			'‡Æ±',
			'‡Æ©',
			'‡Æú',
			'‡Æ∑',
			'‡Æ∏',
			'‡Æ∂'
		],
		telugu: [
			'‡∞Ö',
			'‡∞Ü',
			'‡∞á',
			'‡∞à',
			'‡∞â',
			'‡∞ä',
			'‡∞å',
			'‡±°',
			'‡∞é',
			'‡∞è',
			'‡∞ê',
			'‡∞í',
			'‡∞ì',
			'‡∞î',
			'‡∞Ö‡∞Ç',
			'‡∞Ö‡∞É',
			'‡∞ï',
			'‡∞ñ',
			'‡∞ó',
			'‡∞ò',
			'‡∞ô',
			'‡∞ö',
			'‡∞õ',
			'‡∞ú',
			'‡∞ù',
			'‡∞û',
			'‡∞ü',
			'‡∞†',
			'‡∞°',
			'‡∞¢',
			'‡∞£',
			'‡∞§',
			'‡∞•',
			'‡∞¶',
			'‡∞ß',
			'‡∞®',
			'‡∞™',
			'‡∞´',
			'‡∞¨',
			'‡∞≠',
			'‡∞Æ',
			'‡∞Ø',
			'‡∞∞',
			'‡∞±',
			'‡∞≤',
			'‡∞≥',
			'‡∞µ',
			'‡∞∂',
			'‡∞∑',
			'‡∞∏',
			'‡∞π',
			'‡∞ï‡±ç‡∞∑',
			'‡∞ô‡±ç‡∞û'
		],
		kannada: [
			'‡≤Ö',
			'‡≤Ü',
			'‡≤á',
			'‡≤à',
			'‡≤â',
			'‡≤ã',
			'‡≤å',
			'‡≥°',
			'‡≤é',
			'‡≤è',
			'‡≤ê',
			'‡≤í',
			'‡≤ì',
			'‡≤î',
			'‡≤Ö‡≤É',
			'‡≤ï',
			'‡≤ñ',
			'‡≤ó',
			'‡≤ò',
			'‡≤ô',
			'‡≤ö',
			'‡≤õ',
			'‡≤ú',
			'‡≤û',
			'‡≤ü',
			'‡≤†',
			'‡≤°',
			'‡≤¢',
			'‡≤£',
			'‡≤§',
			'‡≤•',
			'‡≤¶',
			'‡≤ß',
			'‡≤®',
			'‡≤™',
			'‡≤´',
			'‡≤¨',
			'‡≤≠',
			'‡≤∞',
			'‡≤±',
			'‡≤≤',
			'‡≤≥',
			'‡≤µ',
			'‡≤∂',
			'‡≤∑',
			'‡≤∏',
			'‡≤π',
			'‡≤ï‡≥ç‡≤∑',
			'‡≤ú‡≥ç‡≤û'
		],
		malayalam: [
			'‡¥á',
			'‡¥â',
			'‡¥ã',
			'‡µ†',
			'‡¥í',
			'‡¥ï',
			'‡¥ñ',
			'‡¥ó',
			'‡¥ò',
			'‡¥ô',
			'‡¥ö',
			'‡¥õ',
			'‡¥ú',
			'‡¥ü',
			'‡¥†',
			'‡¥§',
			'‡¥•',
			'‡¥¶',
			'‡¥ß',
			'‡¥®',
			'‡¥™',
			'‡¥´',
			'‡¥≠',
			'‡¥Æ',
			'‡¥Ø',
			'‡¥∞',
			'‡¥±',
			'‡¥≤',
			'‡¥≥',
			'‡¥¥',
			'‡¥µ',
			'‡¥∂'
		],
		sinhala: [
			'‡∂Ö',
			'‡∂Ü',
			'‡∂â',
			'‡∂ä',
			'‡∂ã',
			'‡∂å',
			'‡∂è',
			'‡∂ë',
			'‡∂í',
			'‡∂á',
			'‡∂à',
			'‡∂î',
			'‡∂ï',
			'‡∂Ö‡∂Ç',
			'‡∂Ö‡∂É',
			'‡∂ö',
			'‡∂õ',
			'‡∂ú',
			'‡∂ù',
			'‡∂û',
			'‡∂ü',
			'‡∂†',
			'‡∂°',
			'‡∂¢',
			'‡∂ß',
			'‡∂®',
			'‡∂©',
			'‡∂™',
			'‡∂´',
			'‡∂≠',
			'‡∂Æ',
			'‡∂Ø',
			'‡∂∞',
			'‡∂±',
			'‡∂¥',
			'‡∂µ',
			'‡∂∂',
			'‡∂∑',
			'‡∂∏',
			'‡∂∫',
			'‡∂ª',
			'‡∂Ω',
			'‡∑Ä',
			'‡∑Å',
			'‡∑Ç',
			'‡∑É',
			'‡∑Ñ',
			'‡∑Ö',
			'‡∑Ü'
		],
		thai: [
			'‡∏Å',
			'‡∏Ç',
			'‡∏É',
			'‡∏Ñ',
			'‡∏Ö',
			'‡∏Ü',
			'‡∏á',
			'‡∏à',
			'‡∏â',
			'‡∏ä',
			'‡∏ã',
			'‡∏å',
			'‡∏ç',
			'‡∏é',
			'‡∏è',
			'‡∏ê',
			'‡∏ë',
			'‡∏í',
			'‡∏ì',
			'‡∏î',
			'‡∏ï',
			'‡∏ñ',
			'‡∏ú',
			'‡∏ù',
			'‡∏û',
			'‡∏ü',
			'‡∏†',
			'‡∏°',
			'‡∏¢',
			'‡∏£',
			'‡∏§',
			'‡∏¶',
			'‡∏ß',
			'‡∏®',
			'‡∏©',
			'‡∏™',
			'‡∏´',
			'‡∏¨',
			'‡∏≠',
			'‡∏Æ',
			'‡πÇ',
			'‡πÉ',
			'‡πÑ',
			'‡∏≥',
			'‡πÜ'
		],
		lao: [
			'‡∫Å',
			'‡∫Ç',
			'‡∫Ñ',
			'‡∫á',
			'‡∫à',
			'‡∫™',
			'‡∫ä',
			'‡∫ç',
			'‡∫î',
			'‡∫ï',
			'‡∫ñ',
			'‡∫ó',
			'‡∫ô',
			'‡∫ö',
			'‡∫õ',
			'‡∫ú',
			'‡∫ù',
			'‡∫û',
			'‡∫ü',
			'‡∫°',
			'‡∫¢',
			'‡∫£',
			'‡∫•',
			'‡∫ß',
			'‡∫´',
			'‡∫≠',
			'‡∫Æ',
			'‡ªÄ',
			'‡ªÅ',
			'‡ªÇ',
			'‡ªÑ',
			'‡ªÉ',
			'‡ªú',
			'‡ªù',
			'‡ªÜ',
			'‡∫∞',
			'‡∫≤'
		],
		khmer: [
			'·ûÄ',
			'·ûÅ',
			'·ûÇ',
			'·ûÉ',
			'·ûÑ',
			'·ûÖ',
			'·ûÜ',
			'·ûá',
			'·ûà',
			'·ûâ',
			'·ûä',
			'·ûã',
			'·ûå',
			'·ûç',
			'·ûé',
			'·ûè',
			'·ûê',
			'·ûë',
			'·ûí',
			'·ûì',
			'·ûî',
			'·ûï',
			'·ûñ',
			'·ûó',
			'·ûò',
			'·ûô',
			'·ûö',
			'·ûõ',
			'·ûú',
			'·ûü',
			'·û†',
			'·û°',
			'·û¢',
			'·û£',
			'·û§',
			'·û•',
			'·û¶',
			'·ûß',
			'·û®',
			'·û©',
			'·û™',
			'·û´',
			'·û¨',
			'·û≠',
			'·ûÆ',
			'·ûØ',
			'·û∞',
			'·û±',
			'·û≤',
			'·û≥',
			'·üó'
		],
		burmese: [
			'·ÄÄ',
			'·ÄÅ',
			'·ÄÇ',
			'·ÄÉ',
			'·ÄÑ',
			'·ÄÖ',
			'·ÄÜ',
			'·Äá',
			'·Äà',
			'·Ää',
			'·Äã',
			'·Äå',
			'·Äç',
			'·Äé',
			'·Äè',
			'·Äê',
			'·Äë',
			'·Äí',
			'·Äì',
			'·Äî',
			'·Äï',
			'·Äñ',
			'·Äó',
			'·Äò',
			'·Äô',
			'·Äö',
			'·Äõ',
			'·Äú',
			'·Äù',
			'·Äû',
			'·Äü',
			'·Ä†',
			'·Ä°',
			'·Ä£',
			'·Ä§',
			'·Ä•',
			'·Ä¶',
			'·Äß',
			'·Åå',
			'·Åç',
			'·Åè'
		],
		tibetan: [
			'‡ΩÄ',
			'‡ΩÅ',
			'‡ΩÇ',
			'‡ΩÑ',
			'‡ΩÖ',
			'‡ΩÜ',
			'‡Ωá',
			'‡Ωâ',
			'‡Ωè',
			'‡Ωê',
			'‡Ωë',
			'‡Ωì',
			'‡Ωî',
			'‡Ωï',
			'‡Ωñ',
			'‡Ωò',
			'‡Ωô',
			'‡Ωö',
			'‡Ωõ',
			'‡Ωù',
			'‡Ωû',
			'‡Ωü',
			'‡Ω†',
			'‡Ω°',
			'‡Ω¢',
			'‡Ω£',
			'‡Ω§',
			'‡Ω¶',
			'‡Ωß',
			'‡Ω®',
			'‡ΩÇ‡æ±',
			'‡Ωë‡æ≤',
			'‡Ωñ‡æ±',
			'‡Ωò‡æ±',
			'‡ΩÄ‡æ≤',
			'‡Ωñ‡æ≤',
			'‡Ω¶‡æê',
			'‡Ω¶‡æí',
			'‡Ω¶‡æ§',
			'‡Ω¶‡æ¶',
			'‡Ω¶‡æ®',
			'‡Ω¶‡æ©',
			'‡ΩÇ‡æ≤',
			'‡Ω¢‡æê',
			'‡Ω¢‡æí',
			'‡Ω£‡æï',
			'‡Ω£‡æ°',
			'‡Ω£‡æ∑'
		],
		mongolian: [
			'·††',
			'·†°',
			'·†¢',
			'·†£',
			'·†§',
			'·†•',
			'·†¶',
			'·†ß',
			'·†®',
			'·†©',
			'·†™',
			'·†´',
			'·†¨',
			'·†≠',
			'·†Æ',
			'·†Ø',
			'·†∞',
			'·†±',
			'·†≤',
			'·†≥',
			'·†¥',
			'·†µ',
			'·†∂',
			'·†∑',
			'·†∏',
			'·†π',
			'·†∫',
			'·†ª',
			'·†º',
			'·†Ω',
			'·†æ',
			'·†ø',
			'·°Ä',
			'·°Å',
			'·°Ç',
			'·°Ñ',
			'·°Ö',
			'·°Ü',
			'·°á',
			'·°à',
			'·°â',
			'·°ä',
			'·°ã',
			'·°å',
			'·°ç',
			'·°é',
			'·°è',
			'·°ê'
		],
		han: [
			'ÁöÑ',
			'ÊòØ',
			'‰∫Ü',
			'‰∏ç',
			'Âú®',
			'‰∫∫',
			'Êúâ',
			'Êàë',
			'‰ªñ',
			'Ëøô',
			'‰∏™',
			'‰ª¨',
			'‰∏≠',
			'Êù•',
			'‰∏ä',
			'Â§ß',
			'‰∏∫',
			'Âíå',
			'ÂõΩ',
			'Âà∞',
			'Âú∞',
			'‰ª•',
			'ËØ¥',
			'Êó∂',
			'Ë¶Å',
			'Â∞±',
			'Âá∫',
			'‰ºö',
			'ÂèØ',
			'‰πü',
			'‰Ω†',
			'ÂØπ',
			'Áîü',
			'ËÉΩ',
			'ËÄå',
			'Â≠ê',
			'ÈÇ£',
			'Âæó',
			'‰∫é',
			'ÁùÄ',
			'‰∏ã',
			'Ëá™',
			'‰πã',
			'Âπ¥',
			'Ëøá',
			'Âèë',
			'Âêé',
			'‰Ωú',
			'Èáå',
			'Áî®',
			'ÈÅì',
			'Ë°å',
			'ÊâÄ',
			'ÁÑ∂',
			'ÂÆ∂',
			'Áßç',
			'‰∫ã',
			'Êàê',
			'Êñπ',
			'Â§ö',
			'Áªè',
			'Âéª',
			'Ê≥ï',
			'Â≠¶',
			'Â¶Ç',
			'ÈÉΩ',
			'Âêå',
			'Áé∞',
			'ÂΩì',
			'Ê≤°',
			'Âä®',
			'Èù¢',
			'Ëµ∑',
			'Áúã',
			'ÂÆö',
			'Â§©',
			'ÂàÜ',
			'Ëøò',
			'Ëøõ',
			'Â•Ω',
			'Â∞è',
			'ÈÉ®',
			'ÂÖ∂',
			'‰∫õ',
			'‰∏ª',
			'Ê†∑',
			'ÁêÜ',
			'ÂøÉ',
			'Â•π',
			'Êú¨',
			'Ââç',
			'ÂºÄ',
			'‰ΩÜ',
			'Âõ†',
			'Âè™',
			'‰ªé',
			'ÊÉ≥',
			'ÂÆû',
			'Êó•'
		],
		hiragana: [
			'„ÅÇ',
			'„ÅÑ',
			'„ÅÜ',
			'„Åà',
			'„Åä',
			'„Åã',
			'„Åç',
			'„Åë',
			'„Åï',
			'„Åó',
			'„Åô',
			'„Åõ',
			'„Åù',
			'„Åü',
			'„Å°',
			'„Å§',
			'„Å¶',
			'„Å®',
			'„Å™',
			'„Å´',
			'„Å¨',
			'„Å≠',
			'„ÅÆ',
			'„ÅØ',
			'„Å≤',
			'„Åµ',
			'„Åª',
			'„Åæ',
			'„Åø',
			'„ÇÄ',
			'„ÇÅ',
			'„ÇÇ',
			'„ÇÑ',
			'„ÇÜ',
			'„Çà',
			'„Çâ',
			'„Çä',
			'„Çã',
			'„Çå',
			'„Çç',
			'„Çè',
			'„Çí',
			'„Çì',
			'„ÇÉ',
			'„ÇÖ',
			'„Çá',
			'„Å£'
		],
		katakana: [
			'„Ç¢',
			'„Ç§',
			'„Ç¶',
			'„Ç®',
			'„Ç™',
			'„Ç´',
			'„Ç≠',
			'„ÇØ',
			'„Ç±',
			'„Ç≥',
			'„Çµ',
			'„Ç∑',
			'„Çπ',
			'„Çª',
			'„ÇΩ',
			'„Çø',
			'„ÉÅ',
			'„ÉÑ',
			'„ÉÜ',
			'„Éà',
			'„Éä',
			'„Éã',
			'„Éå',
			'„Éç',
			'„Éè',
			'„Éí',
			'„Éï',
			'„Éò',
			'„Éõ',
			'„Éû',
			'„Éü',
			'„É†',
			'„É°',
			'„É¢',
			'„É§',
			'„É¶',
			'„É®',
			'„É©',
			'„É™',
			'„É´',
			'„É¨',
			'„É≠',
			'„ÉØ',
			'„É≤',
			'„É≥',
			'„É£',
			'„É•',
			'„Éß',
			'„ÉÉ'
		],
		hangul: [
			'·ÑÄ',
			'·ÑÅ',
			'·ÑÇ',
			'·ÑÉ',
			'·ÑÑ',
			'·ÑÖ',
			'·ÑÜ',
			'·Ñá',
			'·Ñà',
			'·Ñâ',
			'·Ñä',
			'·Ñã',
			'·Ñå',
			'·Ñç',
			'·Ñé',
			'·Ñè',
			'·Ñê',
			'·Ñë',
			'·Ñí',
			'·Ö°',
			'·Ö¢',
			'·Ö£',
			'·Ö§',
			'·Ö•',
			'·Ö¶',
			'·Öß',
			'·Ö®',
			'·Ö©',
			'·Ö™',
			'·Ö´',
			'·Ö¨',
			'·Ö≠',
			'·ÖÆ',
			'·ÖØ',
			'·Ö∞',
			'·Ü©',
			'·Ü™',
			'·Ü´',
			'·Ü¨',
			'·Ü≠',
			'·ÜÆ',
			'·ÜØ',
			'·Ü∞',
			'·Ü±',
			'·Ü≤',
			'·Ü≥',
			'·Ü¥',
			'·Üµ',
			'·Ü∂',
			'·Ü∑',
			'·Ü∏',
			'·Üπ',
			'·Ü∫',
			'·Üª',
			'·Üº',
			'·ÜΩ',
			'·Üæ',
			'·Üø',
			'·áÄ',
			'·áÅ',
			'·áÇ'
		],
		georgian: [
			'·Éê',
			'·Éë',
			'·Éí',
			'·Éì',
			'·Éî',
			'·Éï',
			'·Éñ',
			'·Éó',
			'·Éò',
			'·Éô',
			'·Éö',
			'·Éõ',
			'·Éú',
			'·Éù',
			'·Éû',
			'·Éü',
			'·É†',
			'·É°',
			'·É¢',
			'·É£',
			'·É§',
			'·É•',
			'·É¶',
			'·Éß',
			'·É®',
			'·É©',
			'·É™',
			'·É´',
			'·É¨',
			'·É≠',
			'·ÉÆ',
			'·ÉØ',
			'·É∞'
		],
		armenian: [
			'‘±',
			'‘≤',
			'‘≥',
			'‘¥',
			'‘µ',
			'‘∂',
			'‘∑',
			'‘∏',
			'‘π',
			'‘∫',
			'‘ª',
			'‘º',
			'‘Ω',
			'‘æ',
			'‘ø',
			'’Ä',
			'’Å',
			'’Ç',
			'’É',
			'’Ñ',
			'’Ö',
			'’Ü',
			'’á',
			'’à',
			'’â',
			'’ä',
			'’ã',
			'’å',
			'’ç',
			'’é',
			'’è',
			'’ê',
			'’ë',
			'’í',
			'’ì',
			'’î',
			'’ï',
			'’ñ',
			'’°',
			'’¢',
			'’£',
			'’§',
			'’•',
			'’¶',
			'’ß',
			'’®',
			'’©',
			'’™',
			'’´',
			'’¨',
			'’≠',
			'’Æ',
			'’Ø',
			'’∞',
			'’±',
			'’≤',
			'’≥',
			'’¥',
			'’µ',
			'’∂',
			'’∑',
			'’∏',
			'’π',
			'’∫',
			'’ª',
			'’º',
			'’Ω',
			'’æ',
			'’ø',
			'÷Ä',
			'÷Å',
			'÷Ç',
			'÷É',
			'÷Ñ',
			'÷Ö',
			'÷Ü'
		],
		ethiopic: [
			'·àÄ',
			'·àÅ',
			'·àÇ',
			'·àÉ',
			'·àÑ',
			'·àÖ',
			'·àÜ',
			'·àà',
			'·àâ',
			'·àä',
			'·àã',
			'·àå',
			'·àç',
			'·àé',
			'·àê',
			'·àë',
			'·àí',
			'·àì',
			'·àî',
			'·àï',
			'·àñ',
			'·àò',
			'·àô',
			'·àö',
			'·àõ',
			'·àú',
			'·àù',
			'·àû',
			'·à†',
			'·à°',
			'·à¢',
			'·à£',
			'·à§',
			'·à•',
			'·à¶',
			'·à®',
			'·à©',
			'·à™',
			'·à´',
			'·à¨',
			'·à≠',
			'·àÆ',
			'·à∞',
			'·à±',
			'·à≤',
			'·à≥',
			'·à¥',
			'·àµ',
			'·à∂',
			'·à∏',
			'·àπ',
			'·à∫',
			'·àª',
			'·àº',
			'·àΩ',
			'·àæ',
			'·âÄ',
			'·âÅ',
			'·âÇ',
			'·âÉ',
			'·âÑ',
			'·âÖ',
			'·âÜ',
			'·âê',
			'·âë',
			'·âí',
			'·âì',
			'·âî',
			'·âï',
			'·âñ',
			'·â†',
			'·â°',
			'·â¢',
			'·â£',
			'·â§',
			'·â•',
			'·â¶',
			'·â®',
			'·â©',
			'·â™',
			'·â´',
			'·â¨',
			'·â≠',
			'·âÆ',
			'·â∞',
			'·â±',
			'·â≤',
			'·â≥',
			'·â¥',
			'·âµ',
			'·â∂',
			'·â∏',
			'·âπ',
			'·â∫',
			'·âª',
			'·âº',
			'·âΩ',
			'·âæ',
			'·äÄ',
			'·äÅ'
		],
		cherokee: [
			'·é†',
			'·é°',
			'·é¢',
			'·é£',
			'·é§',
			'·é•',
			'·é¶',
			'·éß',
			'·é®',
			'·é©',
			'·é™',
			'·é´',
			'·é¨',
			'·é≠',
			'·éÆ',
			'·éØ',
			'·é∞',
			'·é±',
			'·é≤',
			'·é≥',
			'·é¥',
			'·éµ',
			'·é∂',
			'·é∑',
			'·é∏',
			'·éπ',
			'·é∫',
			'·éª',
			'·éº',
			'·éΩ',
			'·éæ',
			'·éø',
			'·èÄ',
			'·èÅ',
			'·èÇ',
			'·èÉ',
			'·èÑ',
			'·èÖ',
			'·èÜ',
			'·èá',
			'·èà',
			'·èâ',
			'·èä',
			'·èã',
			'·èå',
			'·èç',
			'·èé',
			'·èè',
			'·èê',
			'·èë',
			'·èí',
			'·èì',
			'·èî',
			'·èï',
			'·èñ',
			'·èó',
			'·èò',
			'·èô',
			'·èö',
			'·èõ',
			'·èú',
			'·èù',
			'·èû',
			'·èü',
			'·è†',
			'·è°',
			'·è¢',
			'·è£',
			'·è§',
			'·è•',
			'·è¶',
			'·èß',
			'·è®',
			'·è©',
			'·è™',
			'·è´',
			'·è¨',
			'·è≠',
			'·èÆ',
			'·èØ',
			'·è∞',
			'·è±',
			'·è≤',
			'·è≥',
			'·è¥'
		],
		inuktitut: [
			'·êÅ',
			'·êÉ',
			'·êÖ',
			'·êä',
			'·êØ',
			'·ê±',
			'·ê≥',
			'·ê∏',
			'·ëå',
			'·ëé',
			'·ëê',
			'·ëï',
			'·ë´',
			'·ë≠',
			'·ëØ',
			'·ë≤',
			'·íâ',
			'·íã',
			'·íç',
			'·íê',
			'·í£',
			'·í•',
			'·íß',
			'·í™',
			'·ìÄ',
			'·ìÇ',
			'·ìÑ',
			'·ìá',
			'·ìì',
			'·ìï',
			'·ìó',
			'·ìö',
			'·ì¥',
			'·ìØ',
			'·ì±',
			'·ìµ',
			'·îê',
			'·îë',
			'·îì',
			'·îï',
			'·î¶',
			'·î®',
			'·î™',
			'·î≠',
			'·ïÉ',
			'·ïÜ',
			'·ïà',
			'·ïã',
			'·ïê',
			'·ïì',
			'·ïï',
			'·ïó',
			'·ïô',
			'·ïö',
			'·ïû',
			'·ï†',
			'·ï¶',
			'·ïß',
			'·ñÅ',
			'·ñÉ',
			'·ñÖ',
			'·ñï',
			'·ññ'
		],
		vai: [
			'ÍîÄ',
			'ÍîÅ',
			'ÍîÇ',
			'ÍîÉ',
			'ÍîÑ',
			'ÍîÖ',
			'ÍîÜ',
			'Íîá',
			'Íîà',
			'Íîâ',
			'Íîä',
			'Íîã',
			'Íîå',
			'Íîç',
			'Íîé',
			'Íîè',
			'Íîê',
			'Íîë',
			'Íîí',
			'Íîì',
			'Íîï',
			'Íîò',
			'Íîô',
			'Íîö',
			'Íîõ',
			'Íîú',
			'Íîù',
			'Íîû',
			'Íîü',
			'Íî†',
			'Íî°',
			'Íî¢',
			'Íî£',
			'Íî§',
			'Íî•',
			'Íî¶',
			'Íîß',
			'Íî®',
			'Íî©',
			'Íî™',
			'Íî´',
			'Íî¨',
			'Íî≠',
			'ÍîÆ',
			'ÍîØ',
			'Íî∞',
			'Íî±',
			'Íî≤',
			'Íî≥',
			'Íî¥',
			'Íîµ',
			'Íî∂',
			'Íîª',
			'Íîº',
			'ÍîΩ',
			'Íîæ',
			'Íîø',
			'ÍïÉ',
			'ÍïÑ',
			'ÍïÖ',
			'Íïá',
			'Íïà',
			'Íïâ',
			'Íïä',
			'Íïã',
			'Íïå',
			'Íïç',
			'Íïé',
			'Íïè',
			'Íïê',
			'Íïë',
			'Íïí',
			'Íïì',
			'Íïï',
			'Íïñ',
			'Íïó',
			'Íïò',
			'Íïô',
			'Íïö',
			'Íïõ',
			'Íïú',
			'Íïù',
			'Íïû',
			'Íïü',
			'Íï†',
			'Íï°',
			'Íï¢',
			'Íï£'
		],
		nko: [
			'ﬂê',
			'ﬂí',
			'ﬂì',
			'ﬂî',
			'ﬂñ',
			'ﬂò',
			'ﬂö',
			'ﬂõ',
			'ﬂú',
			'ﬂù',
			'ﬂû',
			'ﬂü',
			'ﬂ°',
			'ﬂ¢',
			'ﬂ£',
			'ﬂ§',
			'ﬂ•',
			'ﬂ¶',
			'ﬂß'
		],
		tifinagh: [
			'‚¥≤',
			'‚¥≥',
			'‚¥¥',
			'‚¥µ',
			'‚¥∂',
			'‚¥∑',
			'‚¥∏',
			'‚¥ª',
			'‚¥º',
			'‚¥Ω',
			'‚¥æ',
			'‚¥ø',
			'‚µÄ',
			'‚µÅ',
			'‚µÉ',
			'‚µÑ',
			'‚µÖ',
			'‚µá',
			'‚µí',
			'‚µñ',
			'‚µò',
			'‚µô',
			'‚µö',
			'‚µõ',
			'‚µû',
			'‚µü',
			'‚µ¢',
			'‚µ£',
			'‚µ§',
			'‚µ•'
		],
		syriac: [
			'‹ê',
			'‹í',
			'‹ì',
			'‹ï',
			'‹ó',
			'‹ò',
			'‹ö',
			'‹õ',
			'‹ü',
			'‹†',
			'‹°',
			'‹£',
			'‹•',
			'‹¶',
			'‹®',
			'‹©',
			'‹™',
			'‹´',
			'‹¨',
			'‹üÃ∞',
			'‹ìÃ∞',
			'‹£Ã∞',
			'‹®Ã∞',
			'‹¨Ã∞'
		],
		thaana: [
			'ﬁÄ',
			'ﬁÅ',
			'ﬁÇ',
			'ﬁÉ',
			'ﬁÑ',
			'ﬁÖ',
			'ﬁÜ',
			'ﬁá',
			'ﬁà',
			'ﬁâ',
			'ﬁä',
			'ﬁã',
			'ﬁå',
			'ﬁç',
			'ﬁé',
			'ﬁè',
			'ﬁê',
			'ﬁë',
			'ﬁí',
			'ﬁì',
			'ﬁî',
			'ﬁï',
			'ﬁñ',
			'ﬁó',
			'ﬁò',
			'ﬁô',
			'ﬁö',
			'ﬁõ',
			'ﬁú',
			'ﬁù',
			'ﬁû',
			'ﬁü',
			'ﬁ†',
			'ﬁ°',
			'ﬁ¢',
			'ﬁ£',
			'ﬁ§',
			'ﬁ•'
		],
		osmanya: [
			'êíÄ',
			'êíÅ',
			'êíÇ',
			'êíÉ',
			'êíÑ',
			'êíÖ',
			'êíÜ',
			'êíá',
			'êíà',
			'êíâ',
			'êíä',
			'êíã',
			'êíå',
			'êíç',
			'êíé',
			'êíè',
			'êíê',
			'êíë',
			'êíí',
			'êíì',
			'êíî',
			'êíï',
			'êíñ',
			'êíó',
			'êíò',
			'êíô',
			'êíö',
			'êíõ',
			'êíú',
			'êíù',
			'êí¢'
		],
		adlam: [
			'û§Ä',
			'û§Å',
			'û§Ç',
			'û§É',
			'û§Ñ',
			'û§Ö',
			'û§Ü',
			'û§á',
			'û§à',
			'û§â',
			'û§ä',
			'û§ã',
			'û§å',
			'û§ç',
			'û§é',
			'û§è',
			'û§ê',
			'û§ë',
			'û§í',
			'û§ì',
			'û§î',
			'û§ï',
			'û§ñ',
			'û§ó',
			'û§ò',
			'û§ô',
			'û§ö',
			'û§õ',
			'û§ú',
			'û§ù',
			'û§û',
			'û§ü'
		],
		fraser: [
			'Íìí',
			'Íìï',
			'Íìò',
			'Íìõ',
			'Íìû',
			'Íì§',
			'Íì®',
			'Íì©',
			'Íì™',
			'Íì≠',
			'ÍìØ',
			'Íì±',
			'Íìµ',
			'Íì∂',
			'Íì∑'
		]
	}

	return cloneActiveCharacters(initial)
}

const sanitizeStoredCharacters = (
	stored: unknown
): ActiveCharactersMap | null => {
	if (!stored || typeof stored !== 'object') {
		return null
	}

	const candidate = stored as Record<string, unknown>
	const sanitized: ActiveCharactersMap = {}
	let hasAtLeastOne = false

	writingSystems.forEach(system => {
		const available = new Set(system.characters ?? [])
		const raw = candidate[system.id]
		const list = Array.isArray(raw)
			? (raw as unknown[]).filter(
					(item): item is string =>
						typeof item === 'string' && available.has(item)
			  )
			: []

		sanitized[system.id] = list.length > 0 ? [...list] : Array.from(available)
		if (sanitized[system.id].length > 0) {
			hasAtLeastOne = true
		}
	})

	return hasAtLeastOne ? cloneActiveCharacters(sanitized) : null
}

const loadInitialActiveCharacters = (): ActiveCharactersMap => {
	if (typeof window !== 'undefined') {
		const fromGlobal = window.alphabetsActiveCharacters
		const sanitizedGlobal = sanitizeStoredCharacters(fromGlobal)
		if (sanitizedGlobal) {
			return sanitizedGlobal
		}
	}

	if (typeof window !== 'undefined') {
		try {
			const raw = window.localStorage.getItem(STORAGE_KEY)
			if (raw) {
				const parsed = JSON.parse(raw)
				const sanitizedStored = sanitizeStoredCharacters(parsed)
				if (sanitizedStored) {
					return sanitizedStored
				}
			}
		} catch (error) {
			console.warn('Failed to load stored character preferences:', error)
		}
	}

	return buildDefaultActiveCharacters()
}

const AlphabetsCollagePage: React.FC = () => {
	const [speedMultiplier, setSpeedMultiplier] = useState(SPEED_MAX)
	const [activeCharacters, setActiveCharacters] = useState<ActiveCharactersMap>(
		loadInitialActiveCharacters
	)

	useEffect(() => {
		if (typeof window === 'undefined') {
			return
		}
		try {
			window.localStorage.setItem(STORAGE_KEY, JSON.stringify(activeCharacters))
		} catch (error) {
			console.warn('Failed to persist character preferences:', error)
		}
	}, [activeCharacters])

	const handleToggleCharacter = (systemId: string, char: string) => {
		setActiveCharacters(prev => {
			const current = prev[systemId] ?? []
			const exists = current.includes(char)
			const nextCharacters = exists
				? current.filter(item => item !== char)
				: [...current, char]
			return { ...prev, [systemId]: nextCharacters }
		})
	}

	const characterPool = useMemo(
		() =>
			buildCharacterPool({
				writingSystems,
				activeCharacters,
				gridCellCount: GRID_CELL_COUNT,
				maxShiftPx: DEFAULT_MAX_SHIFT_PX,
				minDuration: DEFAULT_MIN_DURATION,
				maxDuration: DEFAULT_MAX_DURATION,
				randomSeed: RANDOM_SEED
			}),
		[activeCharacters]
	)

	const [visibleCells, setVisibleCells] = useState<CharacterCell[]>(
		characterPool.displayed
	)
	const [spareCells, setSpareCells] = useState<CharacterCell[]>(
		characterPool.queue
	)

	const queueRef = useRef<CharacterCell[]>(characterPool.queue)
	const rotationIndexRef = useRef(0)

	useEffect(() => {
		setVisibleCells(characterPool.displayed)
		setSpareCells(characterPool.queue)
		queueRef.current = characterPool.queue
		rotationIndexRef.current = 0
	}, [characterPool])

	useEffect(() => {
		queueRef.current = spareCells
	}, [spareCells])

	useEffect(() => {
		if (spareCells.length === 0) {
			return
		}

		const interval = window.setInterval(() => {
			setVisibleCells(prevVisible => {
				const currentQueue = queueRef.current
				if (currentQueue.length === 0) {
					return prevVisible
				}

				const nextVisible = [...prevVisible]
				const nextQueue = [...currentQueue]
				const replacements = Math.min(
					Math.max(1, Math.floor(nextVisible.length * 0.1)),
					nextQueue.length
				)

				if (replacements === 0) {
					return prevVisible
				}

				const targetIndices: number[] = []
				const used = new Set<number>()
				while (
					targetIndices.length < replacements &&
					used.size < nextVisible.length
				) {
					const candidate = Math.floor(Math.random() * nextVisible.length)
					if (!used.has(candidate)) {
						used.add(candidate)
						targetIndices.push(candidate)
					}
				}

				targetIndices.forEach(index => {
					const incoming = nextQueue.shift()
					if (!incoming) {
						return
					}
					const outgoing = nextVisible[index]
					nextVisible[index] = incoming
					if (outgoing) {
						nextQueue.push(outgoing)
					}
				})

				queueRef.current = nextQueue
				setSpareCells(nextQueue)
				return nextVisible
			})
		}, 3000)

		return () => window.clearInterval(interval)
	}, [spareCells.length])

	const totalActiveCount = useMemo(() => {
		return Object.values(activeCharacters).reduce(
			(sum, list) => sum + list.length,
			0
		)
	}, [activeCharacters])

	const displayedCount = useMemo(() => {
		const unique = new Set<string>()
		visibleCells.forEach(cell => unique.add(`${cell.scriptId}-${cell.char}`))
		return unique.size
	}, [visibleCells])

	return (
		<div className='alphabets-collage-page'>
			<div className='collage-layout'>
				<section className='collage-frame' aria-label='Writing systems collage'>
					<CollageGrid cells={visibleCells} speedMultiplier={speedMultiplier} />
				</section>

				<section className='controls-panel' aria-label='–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–æ–ª–ª–∞–∂–∞'>
					<div className='controls-header'>
						<h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
						<SpeedControl
							value={speedMultiplier}
							onChange={setSpeedMultiplier}
							min={SPEED_MIN}
							max={SPEED_MAX}
							step={SPEED_STEP}
						/>
						<div className='selection-summary'>
							<span>–í –∫–æ–ª–ª–∞–∂–µ: {displayedCount}</span>
							<span>–í—ã–±—Ä–∞–Ω–æ: {totalActiveCount}</span>
						</div>
					</div>

					<div className='systems-section'>
						{writingSystems.map(system => (
							<WritingSystemCard
								key={system.id}
								system={system}
								activeCharacters={activeCharacters[system.id] ?? []}
								onToggleCharacter={char =>
									handleToggleCharacter(system.id, char)
								}
							/>
						))}
					</div>
				</section>
			</div>
		</div>
	)
}

export default AlphabetsCollagePage
